# API

This repository contains API related artifacts.

The result of the build process is a swagger file in: `swagger/oracle.swagger.json`

Please do not edit this file directly. This file is generated by the build,
using the protobuf and gRPC definitions defined in: `api/{pb,srvpb}/*.proto`.

Within the oracles (middleware), we use grpc-gateway to expose a REST/JSON API
(documented in the swagger file) that is transcoded [0] to a gRPC service that is
consumed internally.

We define entities and endpoints in protobuf and gRPC. This has several
advantages over editing the swagger file directly, including:
  * Clean diffs.
  * Better backwards compatibilty through field numbers.
  * Cleaner (and more clear) semantics for objects and repeated fields.


## Directory Structure

```
├── api                              Contains all API-related files necessary to build API artifacts
|   |
│   ├── Makefile                     Targets to generate API artifacts.
|   |
│   ├── README.md                    This file.
|   |
│   ├── pb                           Contains proto speciations for entities, models, and
|   |                                messages used and referenced in various API endpoints.
|   |
│   ├── srvpb                        Contains endpoint specifications (in gRPC format with
|   |                                HTTP/swagger annotations).
|   |
│   └── swagger                      Contains generated swagger JSON and a Go package that
|   |                                serves the json to frontend clients.
|   |
│   └── third_party/                 3rd party protos.
```

## Generating gRPC service code and Swagger/OpenAPI documentation

The generated gRPC service code, gateway code and the swagger are checked into
git. After every change you should regenerate these files and check them in.

To regenerate these files you can run `make` in the api directory.

## Viewing REST API documentation

You can use your favourite OpenAPI/Swagger tool for viewing the generated
swagger files under api/swagger. `Redoc` is one such tool.

To view the swagger file using redoc, you need to install  the CLI first:

```bash
brew install npm
npm i -g redoc-cli
```

You can then run `make redoc` at the root of the project to view the User API
spec. The port has been set to not conflict with Oracle. You can also run redoc directly:

```bash
npx redoc-cli serve -p 57505 ./api/swagger/oracle.swagger.json
```

You can also use the swagger editor for viewing the swagger specification:
https://editor.swagger.io/

## References

[0] [gRPC Transcoding](https://cloud.google.com/endpoints/docs/grpc/transcoding)
[2] https://confluence.atlassian.com/bitbucket/use-git-lfs-with-existing-bitbucket-repositories-829078749.html
